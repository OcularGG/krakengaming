(()=>{var e={};e.id=3569,e.ids=[3569],e.modules={399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},209:e=>{"use strict";e.exports=require("next/dist/server/app-render/action-async-storage.external.js")},9348:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},412:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},4770:e=>{"use strict";e.exports=require("crypto")},2254:e=>{"use strict";e.exports=require("node:buffer")},6005:e=>{"use strict";e.exports=require("node:crypto")},7261:e=>{"use strict";e.exports=require("node:util")},6913:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>x,routeModule:()=>w,serverHooks:()=>I,workAsyncStorage:()=>v,workUnitAsyncStorage:()=>N});var a={};t.r(a),t.d(a,{GET:()=>g,POST:()=>f});var i=t(5122),n=t(7868),o=t(9769),s=t(1929),c=t(6152),d=t(1021),l=t(5433);let p=d.z.object({captainName:d.z.string().min(2).max(100),preferredNickname:d.z.string().min(1).max(50).optional(),currentNation:d.z.enum(["Great Britain","USA","France","The Pirates","Russia","Sweden"]),timeZone:d.z.string().min(1),hoursInNavalAction:d.z.string().transform(e=>parseInt(e,10)),steamConnected:d.z.boolean(),currentRank:d.z.string().min(1),previousCommands:d.z.string().optional(),preferredRole:d.z.enum(["Commander","Line of Battle","Screener"]),isPortBattleCommander:d.z.boolean(),commanderExperience:d.z.string().optional(),isCrafter:d.z.boolean(),weeklyPlayTime:d.z.string().transform(e=>parseInt(e,10)),portBattleAvailability:d.z.array(d.z.string()),typicalSchedule:d.z.string().min(1),declarationAccuracy:d.z.boolean().refine(e=>!0===e,{message:"You must agree to the accuracy declaration"}),declarationHonor:d.z.boolean().refine(e=>!0===e,{message:"You must agree to the honor declaration"}),declarationRules:d.z.boolean().refine(e=>!0===e,{message:"You must agree to the rules declaration"}),signature:d.z.string().min(1)}),u="1386130264895520868",m=process.env.DISCORD_BOT_TOKEN,h="1387857527873474560";async function y(e,r,t){if(!m)return console.log("Discord bot token not configured, skipping channel creation"),null;try{let a=(r||"applicant").toLowerCase().replace(/[^a-z0-9-]/g,"-").replace(/-+/g,"-").substring(0,45).replace(/^-|-$/g,""),i=`app-${a}`,n=await fetch(`https://discord.com/api/v10/guilds/${u}/channels`,{method:"POST",headers:{Authorization:`Bot ${m}`,"Content-Type":"application/json"},body:JSON.stringify({name:i,type:0,parent_id:"1387857769628962957",permission_overwrites:[{id:u,type:0,deny:"1024"},{id:e,type:1,allow:"1024"},{id:h,type:0,allow:"1024"}]})});if(!n.ok)throw Error(`Failed to create channel: ${n.status}`);let o=await n.json();return(await fetch(`https://discord.com/api/v10/channels/${o.id}/messages`,{method:"POST",headers:{Authorization:`Bot ${m}`,"Content-Type":"application/json"},body:JSON.stringify({embeds:[{title:"âš“ New Application Received",color:1981066,fields:[{name:"Applicant",value:`<@${e}>`,inline:!0},{name:"Display Name",value:r||"Unknown",inline:!0},{name:"Submitted",value:`<t:${Math.floor(Date.now()/1e3)}:F>`,inline:!1},{name:"Application Details",value:`[View Full Application](localhost:3000/admin/applications/${t})`,inline:!1}],footer:{text:`Application ID: ${t}`}}],components:[{type:1,components:[{type:2,style:1,label:"Start Interview",custom_id:`interview_${t}`,emoji:{name:"\uD83C\uDFA4"}}]}]})})).ok||console.error("Failed to send application embed"),await fetch(`https://discord.com/api/v10/channels/${o.id}/messages`,{method:"POST",headers:{Authorization:`Bot ${m}`,"Content-Type":"application/json"},body:JSON.stringify({content:`<@&${h}> New application ready for review!`})}),o.id}catch(e){return console.error("Error creating Discord application channel:",e),null}}async function f(e){try{let r=await (0,c.I8)();if(!r?.user?.discordId)return s.NextResponse.json({error:"Not authenticated"},{status:401});let t=await e.json(),a=p.parse(t),i=await l.prisma.application.findFirst({where:{discordId:r.user.discordId,status:"PENDING"}});if(i)return s.NextResponse.json({error:"You already have a pending application",applicationId:i.id},{status:409});let n=await l.prisma.applicationCooldown.findUnique({where:{discordId:r.user.discordId}});if(n&&n.canReapplyAt&&new Date<n.canReapplyAt)return s.NextResponse.json({error:"You are still in cooldown period",canReapplyAt:n.canReapplyAt.toISOString()},{status:429});let o=await l.prisma.user.findUnique({where:{discordId:r.user.discordId}});o||(o=await l.prisma.user.create({data:{email:r.user.email||"",username:r.user.name||"Unknown",discordId:r.user.discordId}}));let d=await l.prisma.application.create({data:{userId:o.id,discordId:r.user.discordId,discordUsername:r.user.name||"Unknown",applicantName:a.captainName,email:r.user.email,status:"PENDING",captainName:a.captainName,preferredNickname:a.preferredNickname||null,currentNation:a.currentNation,timeZone:a.timeZone,hoursInNavalAction:a.hoursInNavalAction,steamConnected:a.steamConnected,currentRank:a.currentRank,previousCommands:a.previousCommands||null,preferredRole:a.preferredRole,isPortBattleCommander:a.isPortBattleCommander,commanderExperience:a.commanderExperience||null,isCrafter:a.isCrafter,weeklyPlayTime:a.weeklyPlayTime,portBattleAvailability:JSON.stringify(a.portBattleAvailability),typicalSchedule:a.typicalSchedule,declarationAccuracy:a.declarationAccuracy,declarationHonor:a.declarationHonor,declarationRules:a.declarationRules,signature:a.signature}}),u=await y(r.user.discordId,r.user.name||a.captainName,d.id);return u&&await l.prisma.application.update({where:{id:d.id},data:{discordChannelId:u}}),console.log("Application submitted:",d.id),s.NextResponse.json({success:!0,applicationId:d.id,channelId:u})}catch(e){if(e instanceof d.z.ZodError)return s.NextResponse.json({error:"Validation failed",details:e.errors},{status:400});return console.error("Error submitting application:",e),s.NextResponse.json({error:"Failed to submit application"},{status:500})}}async function g(e){try{let e=await (0,c.I8)();if(!e?.user)return s.NextResponse.json({error:"Not authenticated"},{status:401});let r=await l.prisma.application.findMany({orderBy:{submittedAt:"desc"},include:{vouches:{include:{reviewer:!0}}}});return s.NextResponse.json({applications:r})}catch(e){return console.error("Applications fetch error:",e),s.NextResponse.json({error:"Failed to fetch applications"},{status:500})}}let w=new i.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/applications/route",pathname:"/api/applications",filename:"route",bundlePath:"app/api/applications/route"},resolvedPagePath:"C:\\Users\\tijer\\OneDrive\\Documents\\krakengaming\\apps\\frontend\\src\\app\\api\\applications\\route.ts",nextConfigOutput:"standalone",userland:a}),{workAsyncStorage:v,workUnitAsyncStorage:N,serverHooks:I}=w;function x(){return(0,o.patchFetch)({workAsyncStorage:v,workUnitAsyncStorage:N})}},3245:()=>{},6152:(e,r,t)=>{"use strict";t.d(r,{I8:()=>c,handlers:()=>n});var a=t(7708),i=t(1185);let{handlers:n,signIn:o,signOut:s,auth:c}=(0,a.ZP)({providers:[(0,i.Z)({clientId:process.env.DISCORD_CLIENT_ID,clientSecret:process.env.DISCORD_CLIENT_SECRET})],secret:process.env.NEXTAUTH_SECRET,callbacks:{jwt:async({token:e,account:r,profile:t})=>(r&&t&&(e.accessToken=r.access_token,e.discordId=t.id,e.username=t.username,e.discriminator=t.discriminator),e),session:async({session:e,token:r})=>(r&&e.user&&(e.accessToken=r.accessToken,e.user.discordId=r.discordId,e.user.username=r.username,e.user.discriminator=r.discriminator),e)},pages:{error:"/auth/error"},debug:!1})},5433:(e,r,t)=>{"use strict";let a;t.d(r,{prisma:()=>a}),a=new(require("@prisma/client")).PrismaClient}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[9769,4999,7478,1021],()=>t(6913));module.exports=a})();